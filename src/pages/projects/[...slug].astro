---
import ScrollView from "../../components/ScrollView.astro";
import DynamicLink from "../../components/DynamicLink.astro";

import { timeAgo } from "../../utility";

import { getImage } from "astro:assets";
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
    const posts = await getCollection("project");
    return posts.map((project) => ({
        params: { slug: project.id },
        props: project,
    }));
}

type Props = CollectionEntry<"project">;

const post = Astro.props;
const { Content } = await render(post);

const thumbnail =
    post.data.thumbnail != null
        ? await getImage({ src: post.data.thumbnail })
        : null;

const gallery = post.data.gallery
    ? await Promise.all(
          post.data.gallery.map(async (src) => {
              return await getImage({ src });
          }),
      )
    : null;

const videos = post.data.youtubeVideos;

const hasArticle = (post.body || "").length > 0;
---

<Layout
    title={post.data.title}
    description={post.data.description}
    image={post.data.thumbnail}
>
    <div class="project-layout">
        <div class="project-content">
            <header>
                <nav>
                    <a href="/projects">{"<"}</a>
                    {gallery && <a href="#gallery">Gallery</a>}
                    {videos && <a href="#videos">Videos</a>}
                    {hasArticle && <a href="#article">Article</a>}
                </nav>
            </header>
            <ScrollView style="scroll-behavior:smooth;">
                <section id="gallery" class="project-gallery">
                    {
                        gallery &&
                            gallery.map((img) => (
                                <img
                                    loading="lazy"
                                    src={img.src}
                                    width={img.attributes.width}
                                    height={img.attributes.height}
                                />
                            ))
                    }
                </section>
                <Content />
            </ScrollView>
        </div>
        <aside class="project-details">
            <div class="details-header">
                <div
                    class="project-thumbnail"
                    style={`background-image: url(${thumbnail?.src});`}
                >
                </div>
                <span class="project-title">{post.data.title}</span>
            </div>
            <div class="details-body">
                <p>{post.data.description}</p>
                {
                    post.data.date && (
                        <span class="project-age">
                            {timeAgo(post.data.date)}
                        </span>
                    )
                }

                {post.data.links && <hr/>}
                {
                    post.data.links &&
                        post.data.links.map((link) => (
                            <DynamicLink href={link} />
                        ))
                }
            </div>
        </aside>
    </div>
</Layout>

<style>
    nav {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 1rem;
        border-bottom: var(--border-width) solid var(--text-color);
    }

    .internal-links {
        display: flex;
        align-items: center;
    }

    nav a {
        padding: 0.5rem 1.2rem;
        font-size: 1em;
        color: var(--black);
        text-decoration: none;
        text-transform: uppercase;
    }

    nav a:hover {
        background-color: var(--dimmed-glow-color);
    }

    nav a.active {
        background-color: var(--text-color);
        text-shadow: none;
        color: black;
        font-weight: bold;

        text-decoration: none;
    }

    .project-layout {
        display: flex;
        overflow: hidden;
        flex-direction: row;
        flex-grow: 1;
    gap: 1rem;
    }

    .project-content {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        border: var(--border-width) dotted var(--dimmed-glow-color);
        padding: 1rem;
    }

    .project-gallery {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .project-gallery img {
        border-radius: 0;
        image-rendering: auto;
    }

    .project-details {
        display: flex;
        flex-direction: column;
        flex-grow: 0;
        flex-shrink: 0;

        width: 400px;
        border: var(--border-width) dotted var(--dimmed-glow-color);
    }

    .details-body {
        display: flex;
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
        flex-grow: 1;
    }

    .details-body p {
        margin: 0;
    }

    .project-title {
        display: flex;
        background-color: var(--text-color);
        color: black;
        padding: 0.5rem;
        padding-left: 1rem;
        text-shadow: none;
        font-size: 24px;

        text-align: left;
        justify-content: flex-start;
        align-items: center;
    }

    .project-age {
        opacity: 0.3;
    }

    .project-thumbnail {
        display: flex;
        aspect-ratio: 1/1;
        image-rendering: auto;
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
    }
</style>
