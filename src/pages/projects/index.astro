---
import Layout from "../../layouts/Layout.astro";
import ScrollView from "../../components/ScrollView.astro";
import ProjectTile from "../../components/ProjectTile.astro";

import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

type Project = CollectionEntry<"project">;

const raw = await getCollection("project");

// 1. Sort by date (assuming `data.order` is your date/order field)
raw.sort((a, b) => {
    const da = a.data.date?.getTime() ?? 100;
    const db = b.data.date?.getTime() ?? 100;
    return db - da;
});

// 2. Group by "group" field
type ProjectGroups = Record<string, Project[]>;

// 2. Group by `group`
const grouped: ProjectGroups = raw.reduce((acc: any, item) => {
    const key = item.data.group ?? "Ungrouped";
    if (!acc[key]) acc[key] = [];
    acc[key].push(item);
    return acc;
}, {});
---

<Layout title="Projects">
    <div class="main-view">
        <ScrollView style="visibility:hidden">
            {
                Object.entries(grouped).map(([group, posts]) => (
                    <section id={group} class="project-group">
                        <h2>{group}</h2>
                        <div class="project-grid">
                            {posts.map((post) => {
                                return (
                                    <a href={`/projects/${post.id}`}>
                                        <ProjectTile
                                            title={post.data.title}
                                            thumbnail={post.data.thumbnail}
                                            imageCount={
                                                post.data.gallery?.length || 0
                                            }
                                            videoCount={
                                                post.data.videos?.length || 0
                                            }
                                        />
                                    </a>
                                );
                            })}
                        </div>
                    </section>
                ))
            }
        </ScrollView>
    </div>
</Layout>

<script>
    const scroller = document.getElementById("scroll-view") as HTMLElement;
    const key = `scroll:${location.pathname}`;

    function save() {
        sessionStorage.setItem(key, scroller.scrollTop.toString());
    }

    function restore() {
        const pos = sessionStorage.getItem(key);
        if (pos) scroller.scrollTop = Number(pos);
    }

    restore();
    scroller.style.visibility = "visible";

    window.addEventListener("beforeunload", save);
</script>

<style>
    .main-view {
        display: flex;
        overflow: hidden;
    }

    .project-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
        border: var(--border-width) dotted var(--dimmed-glow-color);
        padding: 1rem;
        gap: 1rem;
    }

    .project-group h2 {
        background-color: unset;
        font-size: 1.2rem;
        padding: 0;
        margin: 0;
    }

    .project-group h2::before {
        content: "// ";
    }

    .project-group:first-child .group-header {
        padding-top: 0;
    }

    .date-range {
        color: var(--dimmed-glow-color);
    }

    .project-grid {
        flex-direction: column;
        text-decoration: none;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }

    .project-grid a {
        text-decoration: none;
    }
</style>
